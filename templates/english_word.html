<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>단어 퀴즈</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    typography: {
                        DEFAULT: {
                            css: {
                                maxWidth: 'none',
                                color: '#1e40af',
                                h2: {
                                    color: '#1e40af',
                                    fontSize: '1.25rem',
                                    fontWeight: '600',
                                    marginTop: '1rem',
                                    marginBottom: '0.5rem',
                                },
                                h3: {
                                    color: '#1e40af',
                                    fontSize: '1.125rem',
                                    fontWeight: '600',
                                    marginTop: '0.75rem',
                                    marginBottom: '0.25rem',
                                },
                                strong: {
                                    color: '#1e40af',
                                    fontWeight: '600',
                                },
                                blockquote: {
                                    borderLeftColor: '#3b82f6',
                                    backgroundColor: '#eff6ff',
                                    padding: '0.75rem',
                                    borderRadius: '0.375rem',
                                    margin: '0.5rem 0',
                                },
                                ul: {
                                    marginTop: '0.5rem',
                                    marginBottom: '0.5rem',
                                },
                                li: {
                                    marginTop: '0.25rem',
                                    marginBottom: '0.25rem',
                                }
                            }
                        }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 600px;
            padding: 2rem;
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            animation: fadeIn 0.5s ease-in-out;
            position: relative;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: bold;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn-blue {
            background-color: #3b82f6;
            color: white;
        }
        .btn-blue:hover {
            background-color: #2563eb;
        }
        .btn-green {
            background-color: #10b981;
            color: white;
        }
        .btn-green:hover {
            background-color: #059669;
        }
        .btn-hint {
            background-color: #f59e0b;
            color: white;
        }
        .btn-hint:hover {
            background-color: #d97706;
        }
        .btn-answer {
            background-color: #6b7280;
            color: white;
        }
        .btn-answer:hover {
            background-color: #4b5563;
        }
        input[type="text"] {
            border: 1px solid #d1d5db;
            padding: 0.75rem;
            border-radius: 0.5rem;
            width: 100%;
            transition: border-color 0.2s ease-in-out;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1.5rem;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            animation: scaleIn 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .fade-out {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div id="quiz-container" class="container">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">단어 퀴즈</h1>
        
        <!-- API Key Input Field -->
        <div class="mb-6 flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-2">
            <input type="text" id="api-key-input" class="w-full sm:flex-grow p-2 border border-gray-300 rounded-lg text-sm" placeholder="여기에 Gemini API 키를 입력하세요..." autocomplete="off">
            <button id="save-key-btn" class="btn btn-blue w-full sm:w-auto p-2 text-sm">키 저장</button>
        </div>

        <!-- Loading overlay -->
        <div id="loading-overlay" class="loading-overlay" style="display: none;">
            <div class="loading-spinner"></div>
        </div>

        <!-- Quiz Interface -->
        <div id="quiz-interface" class="flex flex-col items-center">
            <div id="progress" class="text-lg text-gray-600 mb-4 font-semibold"></div>
            <div id="question-box" class="w-full text-center p-8 bg-gray-50 border border-gray-200 rounded-xl mb-6 shadow-inner">
                <div id="word" class="font-extrabold text-blue-600 tracking-wide mb-4 animate-pulse" style="font-size: clamp(1rem, 4vw, 3rem); word-break: break-word; overflow-wrap: break-word;">단어</div>
                <div id="pronunciation" class="text-sm text-gray-500 font-medium"></div>
            </div>
            <div class="flex gap-3 mb-4">
                <input type="text" id="answer-input" class="flex-1 focus:ring-2 focus:ring-blue-500" placeholder="한국어 뜻을 입력하세요..." autocomplete="off" />
                <button id="voice-input-btn" class="btn btn-blue px-4 py-3 flex items-center justify-center" title="음성으로 답변하기">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <div class="flex flex-wrap gap-2">
                <button id="show-answer-btn" class="btn btn-answer text-sm px-4 py-2 flex-[2] min-w-0">정답 보기</button>
                <button id="correct-btn" class="btn btn-green text-sm px-3 py-2 flex-1 min-w-0">맞음</button>
                <button id="submit-btn" class="btn btn-blue text-sm px-4 py-2 flex-[2] min-w-0">제출</button>
                <button id="similar-btn" class="btn btn-hint text-sm px-4 py-2 flex-[2] min-w-0" style="display: none;">예문</button>
                <button id="next-btn" class="btn btn-green text-xl px-8 py-4 flex-[3] min-w-0 font-bold" style="display: none;">다음</button>
            </div>
            
            <div class="flex justify-between gap-2 mt-3">
                <!-- Left side buttons -->
                <div class="flex gap-2">
                    <button id="next-round-btn" class="btn btn-blue text-sm px-3 py-2">다음 라운드</button>
                    <button id="reload-btn" class="btn btn-blue text-sm px-3 py-2">다시 로드</button>
                </div>
                <!-- Right side buttons -->
                <div class="flex gap-2">
                    <button id="hint-btn" class="btn btn-hint text-sm px-3 py-2">힌트</button>
                    <button id="pronunciation-btn" class="btn btn-blue text-sm px-3 py-2">발음</button>
                </div>
            </div>
            
            <!-- Result and Hint Display Area -->
            <div id="result-and-hint-area" class="mt-6 w-full p-4 rounded-lg text-center" style="min-height: 100px;">
                <div id="result" class="w-full p-4 rounded-lg text-center" style="display: none;">
                    <div id="result-message" class="font-bold text-lg mb-2"></div>
                    <div id="similarity-score" class="text-sm font-medium"></div>
                    <div id="correct-answer" class="text-sm text-gray-700 mt-2"></div>
                </div>
                <div id="hint-display" class="w-full p-4 rounded-lg bg-yellow-50 text-yellow-800 font-medium" style="display: none;"></div>
            </div>
            
            <!-- AI Question Input Area -->
            <div id="ai-question-area" class="mt-4 w-full" style="display: none;">
                <div class="flex gap-2 mb-2">
                    <input type="text" id="ai-question-input" class="flex-1 p-2 border border-gray-300 rounded-lg text-sm" placeholder="단어에 대해 궁금한 것을 질문해보세요..." autocomplete="off" />
                    <button id="ai-question-btn" class="btn btn-blue px-4 py-2 text-sm">질문</button>
                </div>
                <div id="ai-answer-display" class="w-full p-4 rounded-lg bg-blue-50 text-blue-800 font-medium prose prose-sm max-w-none" style="display: none;"></div>
            </div>
        </div>
    </div>
    
    <script type="module">
        let words = '';

        // Function to load words from backend
        async function loadWords() {
            try {
                const response = await fetch('/words');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                words = data.words;
                return true;
            } catch (error) {
                console.error('Failed to load words:', error);
                createModal("오류", "단어 목록을 불러오는데 실패했습니다. 페이지를 새로고침해 주세요.");
                return false;
            }
        }

        // Function to create a simple modal
        // This is now only used for input validation and the final quiz result
        function createModal(title, message) {
            const existingModal = document.getElementById('modal');
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.id = 'modal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2 class="text-2xl font-bold mb-2">${title}</h2>
                    <p class="text-lg text-gray-600 mb-4 whitespace-pre-wrap">${message}</p>
                    <button id="modal-close-btn" class="btn btn-blue mt-4">확인</button>
                </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('modal-close-btn').addEventListener('click', () => {
                modal.remove();
            });
        }
        
        // Modal for LLM response
        function createLLMModal(title, message, buttons = []) {
            const existingModal = document.getElementById('modal');
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.id = 'modal';
            modal.className = 'modal';
            let buttonsHTML = buttons.map(btn => `<button id="${btn.id}" class="btn ${btn.className} w-32">${btn.text}</button>`).join('');

            modal.innerHTML = `
                <div class="modal-content !max-w-xl">
                    <h2 class="text-2xl font-bold mb-2">${title}</h2>
                    <p class="text-base text-gray-600 mb-4 whitespace-pre-wrap">${message}</p>
                    <div class="flex justify-center space-x-4">
                        ${buttonsHTML}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            buttons.forEach(btn => {
                document.getElementById(btn.id).addEventListener('click', btn.onClick);
            });
        }

        function removeDiacritics(str) {
            return str.replace(/·/g, '').replace(/…/g, '').replace(/\|/g, '');
        }

        // Fisher-Yates shuffle algorithm for better randomization
        function shuffleArray(array) {
            const shuffled = [...array]; // Create a copy
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        let shuffledWords = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let incorrectWords = [];
        let allWords = [];
        let usedWords = []; // Track which words have been used in current round
        const model = 'gemini-2.5-flash-lite'; // Gemini API model

        const quizContainer = document.getElementById('quiz-container');
        const quizInterface = document.getElementById('quiz-interface');
        const loadingOverlay = document.getElementById('loading-overlay');
        const apiKeyInput = document.getElementById('api-key-input');
        const saveKeyBtn = document.getElementById('save-key-btn');
        const wordElement = document.getElementById('word');
        const pronunciationElement = document.getElementById('pronunciation');
        const answerInput = document.getElementById('answer-input');
        const voiceInputBtn = document.getElementById('voice-input-btn');
        const submitBtn = document.getElementById('submit-btn');
        const correctBtn = document.getElementById('correct-btn');
        const hintBtn = document.getElementById('hint-btn');
        const pronunciationBtn = document.getElementById('pronunciation-btn');
        const showAnswerBtn = document.getElementById('show-answer-btn');
        const similarBtn = document.getElementById('similar-btn');
        const nextBtn = document.getElementById('next-btn');
        const nextRoundBtn = document.getElementById('next-round-btn');
        const reloadBtn = document.getElementById('reload-btn');
        const resultDiv = document.getElementById('result');
        const resultAndHintArea = document.getElementById('result-and-hint-area');
        const hintDisplayDiv = document.getElementById('hint-display');
        const resultMessage = document.getElementById('result-message');
        const similarityScore = document.getElementById('similarity-score');
        const correctAnswerElement = document.getElementById('correct-answer');
        const progressElement = document.getElementById('progress');
        const aiQuestionArea = document.getElementById('ai-question-area');
        const aiQuestionInput = document.getElementById('ai-question-input');
        const aiQuestionBtn = document.getElementById('ai-question-btn');
        const aiAnswerDisplay = document.getElementById('ai-answer-display');

        // Load API key from localStorage on initial load
        let apiKey = localStorage.getItem('gemini-api-key') || "";
        if (apiKey) {
            apiKeyInput.value = apiKey;
        }

        async function startQuiz() {
            if (!words) {
                const loaded = await loadWords();
                if (!loaded) return;
            }
            
            // Parse words and create wordPairs
            const lines = words.split('\n');
            const wordPairs = [];
            let currentWord = null;
            let currentKorean = '';
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue; // Skip empty lines
                
                // Check if this line starts a new word (contains ':')
                if (line.includes(':')) {
                    // Save previous word if exists
                    if (currentWord && currentKorean) {
                        wordPairs.push({
                            english: removeDiacritics(currentWord.trim()),
                            korean: currentKorean.trim().replace(/\[.*?\]/g, '').replace(/\(.*?\)|\.{3}/g, '').trim()
                        });
                    }
                    
                    // Start new word
                    const colonIndex = line.indexOf(':');
                    currentWord = line.substring(0, colonIndex);
                    const koreanPart = line.substring(colonIndex + 1).trim();
                    
                    if (koreanPart) {
                        // Single line format
                        currentKorean = koreanPart;
                    } else {
                        // Multi-line format, collect following lines
                        currentKorean = '';
                        i++; // Move to next line
                        while (i < lines.length) {
                            const nextLine = lines[i].trim();
                            if (!nextLine) {
                                i--; // Go back to empty line
                                break;
                            }
                            if (nextLine.includes(':') && !nextLine.match(/^\d+\./)) {
                                i--; // This is a new word, go back
                                break;
                            }
                            
                            // Remove numbering (1., 2., etc.) and add to korean
                            const cleanLine = nextLine.replace(/^\d+\.\s*/, '');
                            if (cleanLine) {
                                if (currentKorean) currentKorean += '; ';
                                currentKorean += cleanLine;
                            }
                            i++;
                        }
                    }
                }
            }
            
            // Don't forget the last word
            if (currentWord && currentKorean) {
                wordPairs.push({
                    english: removeDiacritics(currentWord.trim()),
                    korean: currentKorean.trim().replace(/\[.*?\]/g, '').replace(/\(.*?\)|\.{3}/g, '').trim()
                });
            }
            
            allWords = [...wordPairs];
            shuffledWords = shuffleArray(allWords);
            currentQuestionIndex = 0;
            incorrectWords = [];
            usedWords = [];
            loadQuestion();
        }

        function startNextRound() {
            // Add unused words to incorrect words
            const unusedWords = shuffledWords.filter(word => !usedWords.includes(word));
            const totalUnusedWords = unusedWords.length;
            
            if (totalUnusedWords === 0) {
                endQuiz();
                return;
            }
            
            // Show confirmation modal
            createLLMModal(
                "다음 라운드 확인", 
                `아직 사용하지 않은 ${totalUnusedWords}개의 단어가 있습니다.\n이 단어들을 "틀린 단어"로 처리하고 다음 라운드를 시작하시겠습니까?`,
                [
                    {
                        id: 'confirm-next-round-btn',
                        text: '네, 다음 라운드 시작',
                        className: 'btn-blue',
                        onClick: () => {
                            document.getElementById('modal').remove();
                            // Proceed with next round
                            incorrectWords = [...incorrectWords, ...unusedWords];
                            shuffledWords = shuffleArray(incorrectWords);
                            currentQuestionIndex = 0;
                            incorrectWords = []; // Reset incorrect words for the new round
                            usedWords = []; // Reset used words for the new round
                            loadQuestion();
                        }
                    },
                    {
                        id: 'cancel-next-round-btn',
                        text: '취소',
                        className: 'btn-gray',
                        onClick: () => {
                            document.getElementById('modal').remove();
                        }
                    }
                ]
            );
        }

        function startIncorrectWordsRound() {
            // Start a new round with only the incorrect words
            if (incorrectWords.length === 0) {
                createModal("알림", "틀린 단어가 없습니다.");
                return;
            }
            
            shuffledWords = shuffleArray(incorrectWords);
            currentQuestionIndex = 0;
            incorrectWords = []; // Reset incorrect words for the new round
            usedWords = []; // Reset used words for the new round
            loadQuestion();
        }

        function loadQuestion() {
            if (currentQuestionIndex >= shuffledWords.length) {
                endRound();
                return;
            }

            const currentWord = shuffledWords[currentQuestionIndex];
            
            // Check if the word contains pronunciation in brackets (e.g., "word [pronunciation]")
            const pronunciationMatch = currentWord.english.match(/^(.+?)\s*\[(.+?)\]$/);
            if (pronunciationMatch) {
                const wordPart = pronunciationMatch[1];
                const pronunPart = pronunciationMatch[2];
                wordElement.textContent = wordPart;
                pronunciationElement.textContent = pronunPart.replace(/[\[\]]/g, '');
            } else {
                // No pronunciation brackets, treat the whole string as the word
                wordElement.textContent = currentWord.english;
                pronunciationElement.textContent = '';
            }
            answerInput.value = '';
            answerInput.disabled = false;
            submitBtn.style.display = 'block';
            correctBtn.style.display = 'block';
            hintBtn.style.display = 'block';
            pronunciationBtn.style.display = 'block';
            showAnswerBtn.style.display = 'block';
            similarBtn.style.display = 'none';
            nextBtn.style.display = 'none';
            
            // Always show "다음 라운드" button
            nextRoundBtn.style.display = 'block';
            
            resultDiv.style.display = 'none';
            hintDisplayDiv.style.display = 'none';
            aiQuestionArea.style.display = 'none';
            aiAnswerDisplay.style.display = 'none';
            hintBtn.disabled = false;
            progressElement.textContent = `문제 ${currentQuestionIndex + 1}/${shuffledWords.length}`;
            wordElement.classList.remove('animate-pulse');
        }
        
        function disableActionButtons() {
            answerInput.disabled = true;
            submitBtn.style.display = 'none';
            correctBtn.style.display = 'none';
            hintBtn.style.display = 'none';
            pronunciationBtn.style.display = 'none';
            showAnswerBtn.style.display = 'none';
            similarBtn.style.display = 'none';
            // Always show "다음 라운드" button when actions are disabled
            nextRoundBtn.style.display = 'block';
            console.log('다음 라운드 버튼 표시됨'); // Debug log
        }

        async function checkAnswer() {
            const userAnswer = answerInput.value.trim().toLowerCase();
            if (!userAnswer) {
                createModal("입력 오류", "답을 입력해 주세요.");
                return;
            }

            if (!apiKey) {
                createModal("API 키 오류", "Gemini API 키를 먼저 입력하고 저장해 주세요.");
                return;
            }

            const currentWord = shuffledWords[currentQuestionIndex];
            const correctAnswers = currentWord.korean;

            // Add current word to used words
            if (!usedWords.includes(currentWord)) {
                usedWords.push(currentWord);
                console.log('사용된 단어 추가 (checkAnswer):', currentWord.english, '총 사용된 단어 수:', usedWords.length);
            }

            disableActionButtons();
            hintDisplayDiv.style.display = 'none';
            showLoading(true);

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            let similarity_score = 0;
            let justification = "";

            try {
                const prompt = `당신은 영어 단어 전문가입니다. 사용자는 영단어 '${currentWord.english}'의 뜻을 '${userAnswer}'라고 입력했습니다. 정답은 '${correctAnswers}'입니다. 사용자의 답과 정답이 얼마나 유사한지 0에서 100점 사이의 점수로 평가하고 그 점수와 간단한 이유를 한국어로 설명해 주세요. 예를 들어 '95. 의미가 매우 유사합니다.'와 같이 답변해주세요. 단, 답변은 점수와 이유로만 구성되어야 합니다.`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: '한국어로 답변해 주세요.' }] },
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Gemini API 호출 실패:', response.status, response.statusText, errorData);
                    throw new Error(`API 호출 실패: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                const llm_response = result.candidates[0].content.parts[0].text;
                
                const match = llm_response.match(/(\d+)\. (.*)/);
                if (match) {
                    similarity_score = parseInt(match[1], 10);
                    justification = match[2];
                }

            } catch (error) {
                console.error("Gemini API 호출 중 오류 발생:", error);
                justification = "유사도 판단에 문제가 발생했습니다.";
                similarity_score = 0;
            } finally {
                showLoading(false);
            }

            similarBtn.style.display = 'block';
            nextBtn.style.display = 'block';
            resultDiv.style.display = 'block';
            aiQuestionArea.style.display = 'block';
            
            const CORRECTNESS_THRESHOLD = 70;

            if (similarity_score >= CORRECTNESS_THRESHOLD) {
                resultDiv.classList.add('bg-green-100', 'text-green-800');
                resultDiv.classList.remove('bg-red-100', 'text-red-800');
                resultMessage.textContent = '정답입니다!';
                score++;
            } else {
                resultDiv.classList.add('bg-red-100', 'text-red-800');
                resultDiv.classList.remove('bg-green-100', 'text-green-800');
                resultMessage.textContent = '오답입니다.';
                incorrectWords.push(currentWord); // Push the whole object
            }
            
            similarityScore.textContent = `유사도: ${similarity_score}점. (${justification})`;
            correctAnswerElement.textContent = `정답: ${currentWord.korean}`;
        }

        async function getHint() {
            if (!apiKey) {
                createModal("API 키 오류", "Gemini API 키를 먼저 입력하고 저장해 주세요.");
                return;
            }

            const currentWord = shuffledWords[currentQuestionIndex];
            
            // Add current word to used words
            if (!usedWords.includes(currentWord)) {
                usedWords.push(currentWord);
                console.log('사용된 단어 추가 (getHint):', currentWord.english, '총 사용된 단어 수:', usedWords.length);
            }

            hintBtn.disabled = true;
            resultDiv.style.display = 'none';
            hintDisplayDiv.style.display = 'block';
            hintDisplayDiv.textContent = "힌트를 생성 중입니다...";
            
            showLoading(true);

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            let hintMessage = "";

            try {
                const prompt = `영단어 '${currentWord.english}'에 대한 뜻을 직접적으로 밝히지 않는 한 문장짜리 한국어 힌트를 제공해주세요. 예를 들어, 관련 단어나 짧은 예문을 제시하거나 단어의 분위기를 설명해 주세요. 답변은 한 문장으로만 구성되어야 합니다.`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: '당신은 사용자의 영어 공부를 도와주는 친절한 튜터입니다. 한국어로 응답해 주세요.' }] },
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Gemini API 호출 실패:', response.status, response.statusText, errorData);
                    throw new Error(`API 호출 실패: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                hintMessage = result.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini API 호출 중 오류 발생:", error);
                hintMessage = "죄송합니다. 힌트를 생성하는 데 문제가 발생했습니다.";
            } finally {
                showLoading(false);
                hintDisplayDiv.textContent = hintMessage;
            }
        }

        function markAsCorrect() {
            const currentWord = shuffledWords[currentQuestionIndex];
            
            // Add current word to used words
            if (!usedWords.includes(currentWord)) {
                usedWords.push(currentWord);
                console.log('사용된 단어 추가 (markAsCorrect):', currentWord.english, '총 사용된 단어 수:', usedWords.length);
            }
            
            disableActionButtons();
            
            resultDiv.style.display = 'block';
            resultDiv.classList.add('bg-green-100', 'text-green-800');
            resultDiv.classList.remove('bg-red-100', 'text-red-800');
            resultMessage.textContent = '정답으로 표시했습니다!';
            similarityScore.textContent = '수동으로 정답 처리됨';
            correctAnswerElement.textContent = `정답: ${currentWord.korean}`;
            
            // Don't add to incorrectWords since it's marked as correct
            score++;

            similarBtn.style.display = 'block';
            nextBtn.style.display = 'block';
            aiQuestionArea.style.display = 'block';
        }

        async function showExampleSentence() {
            if (!apiKey) {
                createModal("API 키 오류", "Gemini API 키를 먼저 입력하고 저장해 주세요.");
                return;
            }

            const currentWord = shuffledWords[currentQuestionIndex];
            
            // Add current word to used words
            if (!usedWords.includes(currentWord)) {
                usedWords.push(currentWord);
                console.log('사용된 단어 추가 (showExampleSentence):', currentWord.english, '총 사용된 단어 수:', usedWords.length);
            }
            
            disableActionButtons();
            hintDisplayDiv.style.display = 'block';
            hintDisplayDiv.textContent = "예문을 생성 중입니다...";
            
            showLoading(true);

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            let exampleSentence = "";

            try {
                const prompt = `영단어 '${currentWord.english}'의 뜻은 '${currentWord.korean}'입니다. 이 단어를 사용한 간단하고 이해하기 쉬운 영어 예문을 하나 만들어주세요. 예문은 한 문장으로만 작성하고, 한국어 번역도 함께 제공해주세요. 형식: "영어 예문 - 한국어 번역"`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: '당신은 사용자의 영어 공부를 도와주는 친절한 튜터입니다. 한국어로 응답해 주세요.' }] },
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Gemini API 호출 실패:', response.status, response.statusText, errorData);
                    throw new Error(`API 호출 실패: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                exampleSentence = result.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini API 호출 중 오류 발생:", error);
                exampleSentence = "죄송합니다. 예문을 생성하는 데 문제가 발생했습니다.";
            } finally {
                showLoading(false);
                hintDisplayDiv.textContent = exampleSentence;
            }

            nextBtn.style.display = 'block';
        }

        function showAnswer() {
            const currentWord = shuffledWords[currentQuestionIndex];
            
            // Add current word to used words
            if (!usedWords.includes(currentWord)) {
                usedWords.push(currentWord);
                console.log('사용된 단어 추가 (showAnswer):', currentWord.english, '총 사용된 단어 수:', usedWords.length);
            }
            
            disableActionButtons();
            
            resultDiv.style.display = 'block';
            resultDiv.classList.remove('bg-green-100', 'text-green-800');
            resultDiv.classList.add('bg-gray-100', 'text-gray-800');
            resultMessage.textContent = '정답을 확인했습니다.';
            similarityScore.textContent = '';
            correctAnswerElement.textContent = `정답: ${currentWord.korean}`;
            
            incorrectWords.push(currentWord);

            similarBtn.style.display = 'block';
            nextBtn.style.display = 'block';
            aiQuestionArea.style.display = 'block';
        }
        
        async function endRound() {
            const totalWordsInRound = shuffledWords.length;
            const correctCount = totalWordsInRound - incorrectWords.length;
            
            let llmMessage = "";

            let prompt = `
            이번 라운드에서 사용자는 ${totalWordsInRound}개 중 ${correctCount}개를 맞혔습니다.
            이 점수에 맞는 격려 메시지를 한 문장으로 작성해 주세요.
            `;
            
            if (incorrectWords.length > 0) {
                prompt += `
                사용자가 틀린 단어들은 다음과 같습니다: ${incorrectWords.map(w => w.english).join(', ')}.
                이 단어들을 더 잘 이해할 수 있도록 각 단어에 대한 간결한 설명을 '단어: 설명' 형태로 제공해주세요.
                `;
            } else {
                prompt += `
                사용자가 모든 문제를 맞혔습니다! 전체 퀴즈가 성공적으로 끝났습니다. 축하 메시지를 작성해 주세요.
                `;
            }

            showLoading(true);

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            let response;
            try {
                response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: '당신은 사용자의 영어 공부를 도와주는 친절한 튜터입니다. 한국어로 응답해 주세요.' }] },
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Gemini API 호출 실패:', response.status, response.statusText, errorData);
                    throw new Error(`API 호출 실패: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                llmMessage = result.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini API 호출 중 오류 발생:", error);
                llmMessage = "죄송합니다. 메시지를 생성하는 데 문제가 발생했습니다.";
            } finally {
                showLoading(false);
            }
            
            let buttons;
            if (incorrectWords.length > 0) {
                buttons = [
                    { id: 'start-next-round-btn', text: '틀린 단어 다시 풀기', className: 'btn-blue', onClick: () => {
                        document.getElementById('modal').remove();
                        startIncorrectWordsRound();
                    }},
                    { id: 'restart-all-btn', text: '처음부터 다시 시작', className: 'btn-green', onClick: () => {
                        document.getElementById('modal').remove();
                        startQuiz();
                    }}
                ];
            } else {
                buttons = [
                    { id: 'restart-all-btn', text: '다시 시작', className: 'btn-blue', onClick: () => {
                        document.getElementById('modal').remove();
                        startQuiz();
                    }}
                ];
            }

            createLLMModal("✨ 라운드 결과 ✨", llmMessage, buttons);
        }

        function endQuiz() {
            // Final message when all words are answered correctly.
            const totalWords = allWords.length;
            const finalMessage = `축하합니다! 모든 단어를 정복했어요.`;
            createModal("퀴즈 완료!", finalMessage);
        }

        function showLoading(show) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }

        async function askAIQuestion() {
            const question = aiQuestionInput.value.trim();
            if (!question) {
                createModal("입력 오류", "질문을 입력해 주세요.");
                return;
            }

            if (!apiKey) {
                createModal("API 키 오류", "Gemini API 키를 먼저 입력하고 저장해 주세요.");
                return;
            }

            const currentWord = shuffledWords[currentQuestionIndex];
            
            aiQuestionBtn.disabled = true;
            aiAnswerDisplay.style.display = 'block';
            aiAnswerDisplay.textContent = "AI가 답변을 생성 중입니다...";
            
            showLoading(true);

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            let aiAnswer = "";

            try {
                const prompt = `영단어 '${currentWord.english}'의 뜻은 '${currentWord.korean}'입니다. 사용자가 "${question}"라고 질문했습니다. 이 질문에 대해 친절하고 도움이 되는 답변을 한국어로 제공해 주세요. 단어의 의미, 사용법, 예문, 어원 등에 대한 질문일 수 있습니다. 답변은 마크다운 형식으로 작성해 주세요. 제목은 ##, 소제목은 ###, 강조는 **굵게**, 예문은 > 인용문으로 표시해 주세요.`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: '당신은 사용자의 영어 공부를 도와주는 친절한 튜터입니다. 한국어로 응답해 주세요.' }] },
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Gemini API 호출 실패:', response.status, response.statusText, errorData);
                    throw new Error(`API 호출 실패: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                aiAnswer = result.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini API 호출 중 오류 발생:", error);
                aiAnswer = "죄송합니다. 답변을 생성하는 데 문제가 발생했습니다.";
            } finally {
                showLoading(false);
                // Render markdown content
                aiAnswerDisplay.innerHTML = marked.parse(aiAnswer);
                aiQuestionBtn.disabled = false;
            }
        }

        function playPronunciation() {
            const currentWord = shuffledWords[currentQuestionIndex];
            const wordToSpeak = currentWord.english;
            
            // Add current word to used words
            if (!usedWords.includes(currentWord)) {
                usedWords.push(currentWord);
                console.log('사용된 단어 추가 (playPronunciation):', currentWord.english, '총 사용된 단어 수:', usedWords.length);
            }
            
            // Check if speech synthesis is supported
            if ('speechSynthesis' in window) {
                // Stop any ongoing speech
                speechSynthesis.cancel();
                
                // Create speech utterance
                const utterance = new SpeechSynthesisUtterance(wordToSpeak);
                utterance.lang = 'en-US';
                utterance.rate = 0.8; // Slightly slower for better understanding
                utterance.pitch = 1;
                utterance.volume = 1;
                
                // Play the speech
                speechSynthesis.speak(utterance);
                
                // Show feedback
                createModal("발음 재생", `"${wordToSpeak}"의 발음을 재생합니다.`);
            } else {
                createModal("지원되지 않음", "이 브라우저에서는 음성 재생을 지원하지 않습니다.");
            }
        }

        function startVoiceInput() {
            // Check if speech recognition is supported
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                createModal("지원되지 않음", "이 브라우저에서는 음성 인식을 지원하지 않습니다.");
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            // Configure recognition
            recognition.lang = 'ko-KR'; // Korean language
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            // Show listening indicator
            voiceInputBtn.innerHTML = `
                <svg class="w-5 h-5 text-red-500 animate-pulse" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"></path>
                </svg>
            `;
            voiceInputBtn.disabled = true;

            recognition.onstart = function() {
                answerInput.placeholder = "listening...";
                answerInput.value = "";
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                answerInput.value = transcript;
                answerInput.placeholder = "한국어 뜻을 입력하세요...";
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                let errorMessage = "음성 인식 중 오류가 발생했습니다.";
                
                switch(event.error) {
                    case 'no-speech':
                        errorMessage = "음성이 감지되지 않았습니다. 다시 시도해주세요.";
                        break;
                    case 'audio-capture':
                        errorMessage = "마이크에 접근할 수 없습니다.";
                        break;
                    case 'not-allowed':
                        errorMessage = "마이크 사용 권한이 필요합니다.";
                        break;
                }
                
                createModal("음성 인식 오류", errorMessage);
            };

            recognition.onend = function() {
                // Reset button
                voiceInputBtn.innerHTML = `
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"></path>
                    </svg>
                `;
                voiceInputBtn.disabled = false;
                
                // Reset placeholder if no text was entered
                if (!answerInput.value.trim()) {
                    answerInput.placeholder = "한국어 뜻을 입력하세요...";
                }
            };

            // Start recognition
            recognition.start();
        }

        function confirmReloadWords() {
            createLLMModal(
                "단어 다시 로드 확인", 
                "현재 진행 중인 퀴즈가 초기화되고 GCS에서 최신 단어 목록을 다시 로드합니다.\n정말로 계속하시겠습니까?",
                [
                    {
                        id: 'confirm-reload-btn',
                        text: '네, 다시 로드',
                        className: 'btn-blue',
                        onClick: () => {
                            document.getElementById('modal').remove();
                            reloadWords();
                        }
                    },
                    {
                        id: 'cancel-reload-btn',
                        text: '취소',
                        className: 'btn-gray',
                        onClick: () => {
                            document.getElementById('modal').remove();
                        }
                    }
                ]
            );
        }

        async function reloadWords() {
            showLoading(true);
            
            try {
                const response = await fetch('/words');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                words = data.words;
                
                // Reset quiz state
                shuffledWords = [];
                currentQuestionIndex = 0;
                score = 0;
                incorrectWords = [];
                usedWords = [];
                allWords = [];
                
                // Parse words and create wordPairs
                const lines = words.split('\n');
                const wordPairs = [];
                let currentWord = null;
                let currentKorean = '';
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue; // Skip empty lines
                    
                    // Check if this line starts a new word (contains ':')
                    if (line.includes(':')) {
                        // Save previous word if exists
                        if (currentWord && currentKorean) {
                            wordPairs.push({
                                english: removeDiacritics(currentWord.trim()),
                                korean: currentKorean.trim().replace(/\[.*?\]/g, '').replace(/\(.*?\)|\.{3}/g, '').trim()
                            });
                        }
                        
                        // Start new word
                        const colonIndex = line.indexOf(':');
                        currentWord = line.substring(0, colonIndex);
                        const koreanPart = line.substring(colonIndex + 1).trim();
                        
                        if (koreanPart) {
                            // Single line format
                            currentKorean = koreanPart;
                        } else {
                            // Multi-line format, collect following lines
                            currentKorean = '';
                            i++; // Move to next line
                            while (i < lines.length) {
                                const nextLine = lines[i].trim();
                                if (!nextLine) {
                                    i--; // Go back to empty line
                                    break;
                                }
                                if (nextLine.includes(':') && !nextLine.match(/^\d+\./)) {
                                    i--; // This is a new word, go back
                                    break;
                                }
                                
                                // Remove numbering (1., 2., etc.) and add to korean
                                const cleanLine = nextLine.replace(/^\d+\.\s*/, '');
                                if (cleanLine) {
                                    if (currentKorean) currentKorean += '; ';
                                    currentKorean += cleanLine;
                                }
                                i++;
                            }
                        }
                    }
                }
                
                // Don't forget the last word
                if (currentWord && currentKorean) {
                    wordPairs.push({
                        english: removeDiacritics(currentWord.trim()),
                        korean: currentKorean.trim().replace(/\[.*?\]/g, '').replace(/\(.*?\)|\.{3}/g, '').trim()
                    });
                }
                
                allWords = [...wordPairs];
                shuffledWords = shuffleArray(allWords);
                currentQuestionIndex = 0;
                incorrectWords = [];
                usedWords = [];
                
                createModal("단어 다시 로드 완료", `총 ${allWords.length}개의 단어를 다시 로드했습니다.`);
                loadQuestion();
                
            } catch (error) {
                console.error('Failed to reload words:', error);
                createModal("오류", "단어를 다시 로드하는데 실패했습니다. 페이지를 새로고침해 주세요.");
            } finally {
                showLoading(false);
            }
        }

        // Event listeners
        submitBtn.addEventListener('click', checkAnswer);
        correctBtn.addEventListener('click', markAsCorrect);
        hintBtn.addEventListener('click', getHint);
        pronunciationBtn.addEventListener('click', playPronunciation);
        voiceInputBtn.addEventListener('click', startVoiceInput);
        showAnswerBtn.addEventListener('click', showAnswer);
        similarBtn.addEventListener('click', showExampleSentence);
        nextBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            loadQuestion();
        });
        nextRoundBtn.addEventListener('click', startNextRound);
        reloadBtn.addEventListener('click', confirmReloadWords);
        aiQuestionBtn.addEventListener('click', askAIQuestion);
        answerInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                if (answerInput.disabled) {
                    nextBtn.click();
                } else {
                    submitBtn.click();
                }
            }
        });
        
        aiQuestionInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                askAIQuestion();
            }
        });

        // Save API key to localStorage
        saveKeyBtn.addEventListener('click', () => {
            apiKey = apiKeyInput.value.trim();
            localStorage.setItem('gemini-api-key', apiKey);
            createModal("키 저장 완료", "Gemini API 키가 성공적으로 저장되었습니다.");
        });
        
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize button states
            nextRoundBtn.style.display = 'block';
            await startQuiz();
        });

    </script>
</body>
</html>
